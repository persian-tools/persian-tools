import { isTruthy } from "../../helpers";

export const validNationalIdPrefixes: Set<string> = new Set([
	"001",
	"002",
	"003",
	"004",
	"005",
	"006",
	"007",
	"008",
	"011",
	"015",
	"020",
	"025",
	"031",
	"032",
	"037",
	"038",
	"041",
	"042",
	"043",
	"044",
	"045",
	"048",
	"049",
	"051",
	"052",
	"053",
	"055",
	"056",
	"057",
	"058",
	"059",
	"060",
	"061",
	"062",
	"063",
	"064",
	"065",
	"067",
	"068",
	"069",
	"070",
	"072",
	"073",
	"074",
	"075",
	"076",
	"077",
	"078",
	"079",
	"081",
	"082",
	"083",
	"084",
	"085",
	"086",
	"087",
	"088",
	"089",
	"090",
	"091",
	"092",
	"093",
	"094",
	"096",
	"097",
	"098",
	"105",
	"106",
	"108",
	"109",
	"110",
	"111",
	"112",
	"113",
	"114",
	"115",
	"116",
	"117",
	"118",
	"119",
	"120",
	"121",
	"122",
	"123",
	"124",
	"125",
	"126",
	"127",
	"128",
	"129",
	"136",
	"137",
	"138",
	"145",
	"146",
	"149",
	"150",
	"152",
	"153",
	"154",
	"155",
	"157",
	"158",
	"159",
	"160",
	"161",
	"162",
	"163",
	"164",
	"165",
	"166",
	"167",
	"168",
	"169",
	"170",
	"171",
	"172",
	"173",
	"174",
	"175",
	"181",
	"182",
	"183",
	"184",
	"185",
	"186",
	"187",
	"188",
	"189",
	"190",
	"191",
	"192",
	"193",
	"194",
	"195",
	"196",
	"197",
	"198",
	"199",
	"200",
	"202",
	"203",
	"205",
	"206",
	"208",
	"209",
	"211",
	"212",
	"213",
	"214",
	"215",
	"216",
	"217",
	"218",
	"219",
	"220",
	"221",
	"222",
	"223",
	"224",
	"225",
	"226",
	"227",
	"228",
	"229",
	"230",
	"236",
	"237",
	"238",
	"239",
	"240",
	"241",
	"242",
	"243",
	"244",
	"245",
	"246",
	"247",
	"248",
	"249",
	"250",
	"251",
	"252",
	"253",
	"254",
	"255",
	"256",
	"257",
	"258",
	"259",
	"261",
	"262",
	"263",
	"264",
	"265",
	"266",
	"267",
	"268",
	"269",
	"270",
	"271",
	"272",
	"273",
	"274",
	"275",
	"279",
	"280",
	"282",
	"283",
	"284",
	"285",
	"286",
	"287",
	"288",
	"289",
	"290",
	"291",
	"292",
	"293",
	"294",
	"295",
	"296",
	"297",
	"298",
	"299",
	"302",
	"303",
	"304",
	"305",
	"306",
	"307",
	"308",
	"309",
	"310",
	"311",
	"312",
	"313",
	"314",
	"315",
	"316",
	"317",
	"318",
	"319",
	"320",
	"321",
	"322",
	"323",
	"324",
	"325",
	"330",
	"331",
	"332",
	"333",
	"334",
	"335",
	"336",
	"337",
	"338",
	"339",
	"341",
	"342",
	"343",
	"344",
	"345",
	"346",
	"347",
	"348",
	"349",
	"350",
	"351",
	"352",
	"353",
	"354",
	"355",
	"356",
	"357",
	"358",
	"359",
	"361",
	"362",
	"364",
	"365",
	"366",
	"367",
	"369",
	"370",
	"371",
	"372",
	"373",
	"375",
	"376",
	"377",
	"378",
	"379",
	"380",
	"381",
	"382",
	"383",
	"384",
	"385",
	"386",
	"387",
	"392",
	"393",
	"394",
	"395",
	"396",
	"397",
	"398",
	"399",
	"400",
	"401",
	"402",
	"403",
	"404",
	"405",
	"406",
	"407",
	"412",
	"413",
	"416",
	"417",
	"418",
	"419",
	"420",
	"421",
	"422",
	"423",
	"424",
	"425",
	"426",
	"427",
	"428",
	"431",
	"432",
	"436",
	"437",
	"438",
	"439",
	"440",
	"441",
	"442",
	"443",
	"444",
	"445",
	"446",
	"447",
	"448",
	"449",
	"450",
	"451",
	"452",
	"453",
	"454",
	"455",
	"456",
	"457",
	"458",
	"459",
	"460",
	"461",
	"462",
	"464",
	"465",
	"466",
	"467",
	"468",
	"469",
	"470",
	"471",
	"472",
	"481",
	"482",
	"483",
	"484",
	"485",
	"486",
	"487",
	"488",
	"489",
	"490",
	"491",
	"492",
	"493",
	"494",
	"495",
	"496",
	"497",
	"498",
	"499",
	"500",
	"501",
	"502",
	"503",
	"504",
	"505",
	"506",
	"507",
	"508",
	"509",
	"510",
	"511",
	"512",
	"513",
	"514",
	"515",
	"516",
	"517",
	"518",
	"519",
	"520",
	"521",
	"522",
	"523",
	"524",
	"525",
	"526",
	"527",
	"528",
	"529",
	"530",
	"531",
	"532",
	"533",
	"534",
	"535",
	"536",
	"537",
	"538",
	"539",
	"540",
	"541",
	"542",
	"543",
	"544",
	"545",
	"546",
	"547",
	"548",
	"549",
	"550",
	"551",
	"552",
	"553",
	"554",
	"555",
	"556",
	"557",
	"558",
	"559",
	"560",
	"561",
	"562",
	"563",
	"564",
	"565",
	"566",
	"567",
	"568",
	"569",
	"570",
	"571",
	"572",
	"573",
	"574",
	"575",
	"576",
	"577",
	"578",
	"579",
	"580",
	"581",
	"582",
	"583",
	"584",
	"585",
	"586",
	"587",
	"588",
	"589",
	"590",
	"591",
	"592",
	"593",
	"594",
	"595",
	"596",
	"597",
	"598",
	"599",
	"600",
	"601",
	"602",
	"603",
	"604",
	"605",
	"606",
	"607",
	"608",
	"609",
	"610",
	"611",
	"612",
	"613",
	"614",
	"615",
	"616",
	"617",
	"618",
	"619",
	"620",
	"621",
	"622",
	"623",
	"624",
	"625",
	"626",
	"627",
	"628",
	"629",
	"630",
	"631",
	"632",
	"633",
	"634",
	"635",
	"636",
	"637",
	"638",
	"639",
	"640",
	"641",
	"642",
	"643",
	"644",
	"645",
	"646",
	"647",
	"648",
	"649",
	"650",
	"651",
	"652",
	"653",
	"654",
	"655",
	"656",
	"657",
	"658",
	"659",
	"660",
	"661",
	"662",
	"663",
	"664",
	"665",
	"666",
	"667",
	"668",
	"669",
	"670",
	"671",
	"672",
	"673",
	"674",
	"675",
	"676",
	"677",
	"678",
	"679",
	"680",
	"681",
	"682",
	"683",
	"684",
	"685",
	"686",
	"687",
	"688",
	"689",
	"690",
	"691",
	"692",
	"693",
	"694",
	"695",
	"696",
	"697",
	"698",
	"699",
	"700",
	"701",
	"702",
	"703",
	"704",
	"705",
	"706",
	"707",
	"708",
	"709",
	"710",
	"711",
	"712",
	"713",
	"714",
	"715",
	"716",
	"717",
	"718",
	"719",
	"720",
	"721",
	"722",
	"723",
	"724",
	"725",
	"726",
	"727",
	"728",
	"729",
	"730",
	"731",
	"732",
	"775",
	"778",
	"986",
]);

// **Predefined dictionary** of disallowed repeated-digit sequences.
export const invalidNationalIdSequences: Set<string> = new Set([
	"0000000000",
	"1111111111",
	"2222222222",
	"3333333333",
	"4444444444",
	"5555555555",
	"6666666666",
	"7777777777",
	"8888888888",
	"9999999999",
]);

/**
 * **Validates Iranian National ID** (Code Melli) using the official checksum algorithm.
 *
 * **Logic**:
 * 1. **Check length**: If it's fewer than 8 digits, reject.
 * 2. **Check if parseInt(code) is 0**: If the entire code is "0..." (e.g., "00000000"), reject.
 * 3. **Zero-pad** the code to length 10 using four leading zeros and slice:
 *    - `code = ('0000' + code).slice(length + 4 - 10)`
 *    - This ensures the final string is exactly 10 characters, padded on the left.
 * 4. **Check the 6 middle digits** (index 3..8):
 *    - If `parseInt(code.slice(3, 9))` is `0`, reject.
 * 5. **Compute the checksum**:
 *    - Extract the last digit (`c = parseInt(code.slice(9, 10))`).
 *    - Multiply each of the first 9 digits by descending weights (10 down to 2).
 *    - Take the sum modulo 11.
 *    - Compare the result to the check digit (`c`).
 * 6. **Return a boolean** indicating if it passes.
 *
 * @param nationalId - The national ID as a string or number.
 * @param options - An optional configuration object.
 * @param options.checkPrefix - Whether to check the first 3 digits against a predefined list of valid city codes. Default is `true`.
 * @returns A boolean indicating whether the ID is valid.
 */
export function verifyIranianNationalId(
	nationalId: string | number,
	options: VerifyIranianNationalIdOptions = { checkPrefix: true },
): boolean {
	if (!isTruthy(nationalId)) {
		return false;
	}

	const idString = String(nationalId).trim();
	const lengthOfId: number = idString.length;

	// **Check** if this ID is one of the known invalid repeated-digit sequences.
	if (invalidNationalIdSequences.has(idString)) {
		return false;
	}

	// **If length < 8** or the parsed integer is zero, **return false**.
	if (lengthOfId < 8 || parseInt(idString, 10) === 0) {
		return false;
	}

	// **Zero-pad** the code to length 10 using the same substring approach:
	//    - "0000" + code => ensures at least 4 zeros, then take .slice(length+4-10).
	//    - If code is length 8, for example, length+4-10 = 2, so we skip 2 chars from the left
	//      of "0000" + code => resulting in a 10-digit string.
	const paddedId = ("0000" + idString).slice(lengthOfId + 4 - 10);

	// **Check the 6 middle digits**: parseInt of substring [3..8] => if 0, **return false**.
	//    - Example: if those 6 digits are "000000", parseInt => 0 => invalid.
	if (parseInt(paddedId.slice(3, 9), 10) === 0) {
		return false;
	}

	// **Check the prefix** if the option is enabled.
	if (options.checkPrefix) {
		// **Extract the 3-digit prefix** and verify that it exists in our valid prefix list.
		const prefix = paddedId.substring(0, 3);
		if (!validNationalIdPrefixes.has(prefix)) {
			return false;
		}
	}

	// **Extract the check digit**: the last character in the 10-digit string.
	const checkDigit = parseInt(paddedId.slice(9, 10), 10);

	// **Compute the weighted sum** of the first 9 digits.
	//    - The i-th digit is multiplied by (10 - i).
	let sum = 0;
	for (let i = 0; i < 9; i++) {
		const digit = parseInt(paddedId.slice(i, i + 1), 10);

		// **Multiply** the digit by the weight (10 - i) and **add** to the sum.
		sum += digit * (10 - i);
	}

	// **Take** the sum modulo 11.
	sum = sum % 11;

	// **Return** whether the check digit matches:
	//    - If sum < 2, a check digit must be sum.
	//    - Otherwise, a check digit must be 11 - sum.
	return (sum < 2 && checkDigit === sum) || (sum >= 2 && checkDigit === 11 - sum);
}

export interface VerifyIranianNationalIdOptions {
	/**
	 * **Check the first 3 digits** of the national ID against a **predefined list** of valid city codes.
	 *
	 * @default true
	 */
	checkPrefix?: boolean;
}

// Export National ID generation functions
export {
	createIranianNationalId,
	createIranianNationalIdDetailed,
	createIranianRoundNationalId,
	isValidNationalIdFormat,
	validateNationalIdChecksum,
	type NationalIdGenerationOptions,
	type NationalIdGenerationResult,
} from "./create-national-id";
